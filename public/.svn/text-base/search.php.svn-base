<?php

include('../lib/common.php');

switch($_REQUEST['action']){

	case 'show':

		$objSearch = new Search($_REQUEST['id']);
		if(!$objSearch->isLoaded()){
			$objError = new Error("Tried to load a non-existant search", Error::FATAL);
			exit;
		}

		showSearch('', $objSearch);

	break;

	case 'started':

		$objSearch = new Search($_REQUEST['id']);
		if(!$objSearch->isLoaded()){
			$objError = new Error("Tried to load a non-existant search", Error::FATAL);
			exit;
		}

		showSearch('Your download has been started', $objSearch);

	break;

	case 'info':

		$objSearchResult = new SearchResult($_REQUEST['id']);

		if(!$objSearchResult->isLoaded()){
			$objError = new Error("Requested information for a non-existant download", Error::FATAL);
			exit;
		}

		showInfo($objSearchResult);

	break;

	case 'results':
		$objEasynews = new Easynews();
		Progress::heading('Searching Newsgroups');
		Progress::update('Please wait...');

		Audit::message('Searched for: ' . $_REQUEST['chrPhrase']);
		$objSearch = $objEasynews->search($_REQUEST['chrPhrase']);

		if(sizeof(SearchResult::find_by_search($objSearch->getID())) > 0){
			Page::location("/search/show/{$objSearch->getID()}");
		} else {
			showSearch("No search results found - try simplifying your search terms");
		}

	default:
		showSearch();

}


/**
 * Displays a search page
 * @param $chrMessage = ''
 * @return true
 */
function showSearch( $chrMessage = '', $objSearch = false) {

	if(strlen($chrMessage) > 0){
		$chrMessage = "<p class=\"error\">$chrMessage</p>";
	} else {
		$chrMessage = "<p class=\"info\">Enter a movie or tv show name to search for:</p>";
	}

	$chrHTML = "
	$chrMessage
	<div class=\"form\">
		<form id=\"frmSearch\" name=\"frmLogin\" action=\"/search/results\" method=\"post\">
			<div class=\"fm-req\">
				<label for=\"chrPhrase\">Search:</label>
				<input type=\"text\" id=\"chrPhrase\" name=\"chrPhrase\" value=\"{$_REQUEST['chrPhrase']}\" />
				<a href=\"javascript:document.frmSearch.submit();\">
					<img src=\"/images/icons/world_go.png\" />
				</a>
			</div>
    	</form>
	</div>
	";

	if($objSearch !== false){

		$chrHTML .= "
		<div class=\"form\">
			<form id=\"frmInfo\" name=\"frmInfo\" action=\"/search/info\" method=\"post\">
				<table width=\"100%\" id=\"underline\">
					<tr>
						<td colspan=\"2\"><b>File</b></td>
						<td><b>Size</b></td>
					</tr>
		";

		$arrSearchResults = SearchResult::find_by_search($objSearch->getID());

		foreach($arrSearchResults as $idSearchResult){

			$objSearchResult = new SearchResult($idSearchResult);

			$chrFilename = urldecode(basename($objSearchResult->getURL()));
			$arrFilename = explode('.', $chrFilename);
			$chrExtension = strtolower(end($arrFilename));

			switch($chrExtension){

				case 'iso':
				case 'bin':
				case 'cue':
				case 'dat':
					$chrIcon = '/images/icons/cd.png';
				break;

				case 'avi':
				case 'wmv':
				case 'mkv':
				case 'mp4':
					$chrIcon = '/images/icons/dvd.png';
				break;

				case 'mp3':
				case 'wav':
					$chrIcon = '/images/icons/sound.png';
				break;

				case 'zip':
				case 'rar':
				case '7zip':
					$chrIcon = '/images/icons/compress.png';

				default:
					$chrIcon = '/images/icons/package.png';

			}

			$chrHTML .= "
			<tr>
				<td><img src=\"$chrIcon\"></td>
				<td><a href=\"/search/info/$idSearchResult\">$chrFilename</a></td>
				<td align=\"right\">{$objSearchResult->getSize()}</td>
			</tr>
			";

		}

		$chrHTML .= "
			</table>
			<input type=\"hidden\" name=\"encResult\" value=\"\">
		</form>";

	}

	$objPage = new Page();
	$objPage->setBody($chrHTML);
	$objPage->draw();

	return true;

} # end method

/**
 * Displays information about a download
 * @param Array $arrResult
 * @return true
 */
 function showInfo( SearchResult $objSearchResult ) {

 	$objEasynews = new Easynews();
 	$arrInfo = $objEasynews->getInfo($objSearchResult->getURL());

 	if(strlen($objSearchResult->getThumbnail()) > 0){
 		$chrThumb = "<img style=\"width: 100%;\" src=\"/thumb/show/{$objSearchResult->getID()}\" />";
 	}

 	$intCount = 0;
 	foreach((Array) $arrInfo['video'] as $arrTrack){

 		$intCount++;

 		$chrWidth = str_replace('pixels', '', $arrTrack['Width']);
 		$chrWidth = str_replace(' ', '', $chrWidth);

 		$chrHeight = str_replace('pixels', '', $arrTrack['Height']);
 		$chrHeight = str_replace(' ', '', $chrHeight);

 		$chrBitRate = '';

 		if(isset($arrTrack['Bit_rate'])){
 			$chrBitRate = '@ ' . $arrTrack['Bit_rate'];
 		}

 		if(isset($arrTrack['Nominal_bit_rate'])){
 			$chrBitRate = '@ ' . $arrTrack['Nominal_bit_rate'];
 		}

 		if(isset($arrTrack['Language'])){
 			$chrLanguage = $arrTrack['Language'];
 		} else {
 			$chrLanguage = "Unknown";
 		}


 		$chrFormat = "{$chrWidth}x{$chrHeight}px ({$arrTrack['Display_aspect_ratio']}) $chrBitRate";

 		$chrTracks .= "
			<tr>
				<td width=\"20\"><img src=\"/images/icons/monitor.png\"></td>
				<td>Video #$intCount</td>
				<td>$chrLanguage</td>
				<td>$chrFormat</td>
			</tr>
 		";

 	}

 	$intCount = 0;
 	foreach((Array) $arrInfo['audio'] as $arrTrack){

 		$intCount++;

 		if(isset($arrTrack['Title'])){
 			$chrTitle = "{$arrTrack['Title']}";
 		} else {
 			$chrTitle = "Audio #$intCount";
 		}

 		$chrAudioRate = '';

 		if(isset($arrTrack['Sampling_rate'])){
 			$chrAudioRate = '@ ' . $arrTrack['Sampling_rate'];
 		}

 		if(isset($arrTrack['Bit_rate'])){
 			$chrAudioRate = '@ ' . $arrTrack['Bit_rate'];
 		}

 		if(isset($arrTrack['Nominal_bit_rate'])){
 			$chrAudioRate = '@ ' . $arrTrack['Nominal_bit_rate'];
 		}

 		if(isset($arrTrack['Language'])){
 			$chrLanguage = $arrTrack['Language'];
 		} else {
 			$chrLanguage = "Unknown";
 		}

 		$chrTracks .= "
			<tr>
				<td width=\"20\"><img src=\"/images/icons/sound.png\"></td>
				<td>$chrTitle</td>
				<td>$chrLanguage</td>
				<td>{$arrTrack['Format']} ({$arrTrack['Channel_s_']}) $chrAudioRate</td>
			</tr>
 		";

 	}

 	$intCount = 0;
 	foreach((Array) $arrInfo['subtitle'] as $arrTrack){

 		$intCount++;

 		if(isset($arrTrack['Language'])){
 			$chrLanguage = $arrTrack['Language'];
 		} else {
 			$chrLanguage = "Unknown";
 		}

 		$chrTracks .= "
			<tr>
				<td width=\"20\"><img src=\"/images/icons/text_dropcaps.png\"></td>
				<td>Subtitle #$intCount</td>
				<td>$chrLanguage</td>
				<td>{$arrTrack['Format']}</td>
			</tr>
 		";

 	}

 	$chrHTML = "
 	<form id=\"frmDownload\" name=\"frmDownload\" action=\"/download\" method=\"post\">
 	<div class=\"box\">
		<div class=\"box_inner\">
			<p>
				<table width=\"100%\">
		 			<tr>
		 				<td>
		 					<b>Name:</b> " . urldecode(basename($objSearchResult->getURL())) . "<br />
		 					<b>Format:</b> {$arrInfo['general'][0]['Format']}<br />
		 					<b>Size:</b> {$objSearchResult->getSize()}<br />
		 					<b>Duration:</b> {$arrInfo['general'][0]['Duration']}<br />
		 				</td>
		 				<td align=\"right\" valign=\"middle\">
		 					<a href=\"/download/start/{$objSearchResult->getID()}\">
		 						<img style=\"width: 50px;\" src=\"/images/download.png\">
		 					</a>
		 				</td>
		 			</tr>
		 		</table>
			</p>
		</div>
	</div>
	<table width=\"100%\" id=\"underline\">
			<tr>
				<td colspan=\"2\"><b>Audio / Video / Subtitles</b></td>
				<td><b>Language</b></td>
				<td><b>Format</b></td>
			</tr>
			$chrTracks
	</table>
	</form>
 	$chrThumb
 	";

 	$objPage = new Page();
	$objPage->setBody($chrHTML);
	$objPage->draw();

	return true;

} # end method


