<?php

class Error extends Base {
	
	const WARNING = 1;
	const CRITICAL = 2;
	const FATAL = 3;
	
	protected $chrMessage;
	protected $intLevel;
	protected $arrTrace;
	
	/*##########################################################################*//**
	 * Class Constructor
	 * @param $chrMessage = 'Unknown Error'
	 * @return true;
	 */
	function __construct( $chrMessage = 'Unknown Error', $intLevel) {

		@error_log($chrMessage, 0);
		
		$this->setMessage($chrMessage);
		$this->setLevel($intLevel);
		
		switch($intLevel){
			
			case self::WARNING:
				Audit::message('Warning: ' . $this->getMessage());
			break;
			
			case self::CRITICAL:
				Audit::message('Error: ' . $this->getMessage());
			break;
			
			case self::FATAL:
				
				$objPage = new Page();
				$objPage->setPageTitle("fatal.<span>error</span>");
				$objPage->setPageSubtitle("A fatal error has occurred");
				
				if(is_object($chrMessage)){
					
					$arrTrace = end($chrMessage->getTrace());
					$chrError = $chrMessage->getMessage();
					
				} else {
					$arrTrace = end(debug_backtrace());
					$chrError = $chrMessage;				
				}
				
				if(isset($arrTrace['class'])){
					$chrFunction = "{$arrTrace['class']}::{$arrTrace['function']}();";
				} else {
					$chrFunction = "{$arrTrace['function']}();";
				}
		
				#Audit::message("Fatal: $chrError");
				
				$chrBody = "
					
					<div class=\"box\">
						<div class=\"box_inner\">	
							<div class=\"captioned_image\">
								<img alt=\"Error\" src=\"/images/error.png\" />
								<div></div>
							</div>
							<h2>$chrError</h2>
							<p>
								<i>The error occured in the following location:</i> <br />
								<b>File: </b>" . basename($arrTrace['file']) . "  (line {$arrTrace['line']})<br />
								<b>Function: </b>$chrFunction
							</p>		
						</div>
					</div>
					<h3>Error Summary</h3>
					<p>
						Looks like something pretty serious has gone wrong and it hasn't been possible to recover<br />
						A site administrator has been automatically notified of the problem and will investigate soon<br />
					</p>
					";
				
				
				$objPage->setBody($chrBody);
				$objPage->draw(false);
				#display(debug_backtrace());
				
				
				exit;
						
				
			break;
		
		}
		
		
		
		return true;
	
	} # end method
	
}
